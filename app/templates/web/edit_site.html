{% extends "base.html" %}

{% block title %}Edit Site - Nginx Site Manager{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Page Header -->
    <div class="dashboard-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-secondary me-3" onclick="history.back()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div>
                        <h1 class="dashboard-title mb-0">
                            <i class="fas fa-edit me-2"></i>Edit Site Configuration
                        </h1>
                        <p class="dashboard-subtitle mb-0">
                            Modify site settings and configuration
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-md-end">
                <button type="button" class="btn btn-outline-danger" onclick="cancelEdit()">
                    <i class="fas fa-times me-2"></i>Cancel Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Form -->
    <div class="content-section">
        <form id="editSiteForm">
        <div class="row">
            <div class="col-lg-8">
            <!-- Basic Configuration Section -->
            <div class="config-section mb-4">
                <div class="config-section-header">
                    <h4 class="config-section-title">
                        <i class="fas fa-info-circle me-2"></i>Basic Information
                    </h4>
                </div>
                <div class="config-section-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="siteName" class="form-label">Site Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="siteName" readonly>
                            <small class="text-muted">Site name cannot be changed</small>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="domain" class="form-label">Domain <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="domain" name="domain" required>
                            <small class="text-muted">Example: example.com or subdomain.example.com</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Site Type Configuration Section -->
            <div class="config-section mb-4">
                <div class="config-section-header">
                    <h4 class="config-section-title">
                        <i class="fas fa-layer-group me-2"></i>Site Type Configuration
                    </h4>
                </div>
                <div class="config-section-body">
                    <div class="mb-3">
                        <label class="form-label">Site Type <span class="text-danger">*</span></label>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="site-type-card">
                                    <input class="form-check-input" type="radio" name="type" id="typeStatic" value="static">
                                    <label class="form-check-label w-100" for="typeStatic">
                                        <div class="text-center p-3">
                                            <i class="fas fa-file-code text-primary fs-2 mb-2 d-block"></i>
                                            <strong>Static Site</strong>
                                            <small class="text-muted d-block mt-1">Serve HTML, CSS, JS files</small>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="site-type-card">
                                    <input class="form-check-input" type="radio" name="type" id="typeProxy" value="proxy">
                                    <label class="form-check-label w-100" for="typeProxy">
                                        <div class="text-center p-3">
                                            <i class="fas fa-exchange-alt text-info fs-2 mb-2 d-block"></i>
                                            <strong>Reverse Proxy</strong>
                                            <small class="text-muted d-block mt-1">Forward to another server</small>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="site-type-card">
                                    <input class="form-check-input" type="radio" name="type" id="typeLoadBalancer" value="load_balancer">
                                    <label class="form-check-label w-100" for="typeLoadBalancer">
                                        <div class="text-center p-3">
                                            <i class="fas fa-balance-scale text-warning fs-2 mb-2 d-block"></i>
                                            <strong>Load Balancer</strong>
                                            <small class="text-muted d-block mt-1">Distribute across servers</small>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dynamic Type-Specific Configuration -->
                    <div id="typeSpecificConfig">
                        <!-- Static Site Configuration -->
                        <div id="staticConfig" class="config-section mt-4" style="display: none;">
                            <div class="config-section-header">
                                <h4 class="config-section-title">
                                    <i class="fas fa-file-code me-2"></i>Static Site Settings
                                </h4>
                            </div>
                            <div class="config-section-body">
                                <div class="mb-3">
                                    <label for="indexFiles" class="form-label">Index Files</label>
                                    <input type="text" class="form-control" id="indexFiles" value="index.html,index.htm">
                                    <small class="text-muted">Comma-separated list of index files (e.g., index.html, index.htm)</small>
                                </div>
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Files will be served from: <code>/var/www/[site-name]/</code>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Reverse Proxy Configuration -->
                        <div id="proxyConfig" class="config-section mt-4" style="display: none;">
                            <div class="config-section-header">
                                <h4 class="config-section-title">
                                    <i class="fas fa-exchange-alt me-2"></i>Reverse Proxy Settings
                                </h4>
                            </div>
                            <div class="config-section-body">
                                <div class="mb-3">
                                    <label for="upstreamUrl" class="form-label">Upstream URL <span class="text-danger">*</span></label>
                                    <input type="url" class="form-control" id="upstreamUrl" placeholder="http://localhost:3000">
                                    <small class="text-muted">The backend server URL to proxy requests to</small>
                                </div>
                                <div class="alert alert-warning mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Ensure the upstream server is accessible from this nginx instance
                                </div>
                            </div>
                        </div>
                        
                        <!-- Load Balancer Configuration -->
                        <div id="loadBalancerConfig" class="config-section mt-4" style="display: none;">
                            <div class="config-section-header">
                                <h4 class="config-section-title">
                                    <i class="fas fa-balance-scale me-2"></i>Load Balancer Settings
                                </h4>
                            </div>
                            <div class="config-section-body">
                                <div class="mb-3">
                                    <label for="upstreamServers" class="form-label">Upstream Servers <span class="text-danger">*</span></label>
                                    <div id="serversList">
                                        <!-- Server inputs will be added here -->
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addServerInput()">
                                        <i class="fas fa-plus me-2"></i>Add Server
                                    </button>
                                    <small class="text-muted d-block mt-1">Enter server URLs (e.g., http://server1:8080)</small>
                                </div>
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Traffic will be distributed across all configured servers using round-robin
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SSL Configuration Section -->
            <div class="config-section mb-4">
                <div class="config-section-header">
                    <h4 class="config-section-title">
                        <i class="fas fa-lock me-2"></i>SSL Configuration
                    </h4>
                </div>
                <div class="config-section-body" id="sslSection">
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="sslEnabled" name="ssl_enabled">
                                    <label class="form-check-label" for="sslEnabled">
                                        <strong>Enable SSL (HTTPS)</strong>
                                    </label>
                                    <div class="form-text">Enable automatic SSL certificate generation with Let's Encrypt</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div id="sslStatus" class="text-end">
                                    <!-- SSL status badge will be shown here -->
                                </div>
                            </div>
                        </div>
                        
                        <div id="sslOptions" class="d-none">
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label for="sslEmail" class="form-label">Email for Let's Encrypt <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="sslEmail" name="ssl_email" placeholder="admin@example.com">
                                    <div class="form-text">Required for certificate renewal notifications</div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Certificate Actions</label>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-outline-success btn-sm" id="generateCertBtn" onclick="generateSSLCertificate()">
                                            <i class="fas fa-certificate me-1"></i>Generate
                                        </button>
                                        <button type="button" class="btn btn-outline-warning btn-sm" id="renewCertBtn" onclick="renewSSLCertificate()" style="display: none;">
                                            <i class="fas fa-sync me-1"></i>Renew
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="sslCertInfo" class="d-none">
                                <div class="alert alert-info">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <small><strong>Certificate Status:</strong> <span id="certStatus"></span></small><br>
                                            <small><strong>Issuer:</strong> Let's Encrypt</small>
                                        </div>
                                        <div class="col-md-6">
                                            <small><strong>Expires:</strong> <span id="certExpiry"></span></small><br>
                                            <small><strong>Days Remaining:</strong> <span id="certDaysLeft"></span></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-warning">
                                <div class="d-flex">
                                    <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                                    <div>
                                        <small><strong>Requirements for SSL:</strong></small>
                                        <ul class="small mb-0 mt-1">
                                            <li>Domain must point to this server</li>
                                            <li>Site must be accessible via HTTP (port 80)</li>
                                            <li>Site must be enabled before generating SSL certificate</li>
                                            <li>Domain validation may take a few minutes</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
            </div>

            <!-- Form Actions Section -->
            <div class="config-section mb-4">
                <div class="config-section-header">
                    <h4 class="config-section-title">
                        <i class="fas fa-tools me-2"></i>Actions
                    </h4>
                </div>
                <div class="config-section-body">
                    <div class="d-flex justify-content-between flex-wrap gap-3">
                        <button type="button" class="btn btn-outline-info" onclick="testConfiguration()">
                            <i class="fas fa-vial me-2"></i>Test Configuration
                        </button>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-danger" onclick="cancelEdit()">
                                <i class="fas fa-times me-2"></i>Cancel
                            </button>
                            <button type="submit" class="btn btn-primary" form="editSiteForm">
                                <i class="fas fa-save me-2"></i>Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="config-section">
                <div class="config-section-header">
                    <h4 class="config-section-title">
                        <i class="fas fa-info-circle me-2"></i>Edit Guidelines
                    </h4>
                </div>
                <div class="config-section-body">
                    <ul class="small text-muted mb-0">
                        <li>Domain changes will update the nginx server configuration</li>
                        <li>Changing site type will regenerate the entire configuration</li>
                        <li>For static sites, ensure files exist in the web directory</li>
                        <li>For proxy sites, verify the upstream server is accessible</li>
                        <li>Configuration changes require nginx reload to take effect</li>
                        <li>Test configuration before saving to avoid issues</li>
                    </ul>
                </div>
            </div>
            
            <div class="config-section">
                <div class="config-section-header">
                    <h4 class="config-section-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>Important Notes
                    </h4>
                </div>
                <div class="config-section-body">
                    <div class="alert alert-warning mb-0">
                        <small>
                            <strong>Warning:</strong> Changing site type from static to proxy/load balancer 
                            will not delete existing files in <code>/var/www/[site-name]/</code>
                        </small>
                    </div>
                </div>
            </div>
        </div>
        </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const siteId = {{ site_id }};
let originalSiteData = null;

document.addEventListener('DOMContentLoaded', function() {
    loadSiteData();
    setupFormHandlers();
});

async function loadSiteData() {
    try {
        const response = await fetchWithAuth(`/api/sites/${siteId}`);
        if (!response.ok) {
            if (response.status === 404) {
                showToast('Error', 'Site not found', 'error');
                setTimeout(() => window.location.href = '/sites', 1500);
                return;
            }
            throw new Error('Failed to load site data');
        }
        
        originalSiteData = await response.json();
        populateForm(originalSiteData);
        
    } catch (error) {
        console.error('Error loading site:', error);
        showToast('Error', error.message, 'error');
    }
}

function populateForm(siteData) {
    // Basic fields
    document.getElementById('siteName').value = siteData.name;
    document.getElementById('domain').value = siteData.domain;
    
    // Site type
    const typeRadio = document.querySelector(`input[name="type"][value="${siteData.type}"]`);
    if (typeRadio) {
        typeRadio.checked = true;
        showConfigSection(siteData.type);
    }
    
    // Configuration based on type
    const config = siteData.config || {};
    
    if (siteData.type === 'static') {
        const indexFiles = config.index_files || ['index.html', 'index.htm'];
        document.getElementById('indexFiles').value = indexFiles.join(',');
        
    } else if (siteData.type === 'proxy') {
        document.getElementById('upstreamUrl').value = config.upstream_url || '';
        
    } else if (siteData.type === 'load_balancer') {
        const servers = config.upstream_servers || [];
        const serversList = document.getElementById('serversList');
        serversList.innerHTML = '';
        
        if (servers.length === 0) {
            addServerInput();
        } else {
            servers.forEach(server => addServerInput(server));
        }
    }
    
    // SSL Configuration
    document.getElementById('sslEnabled').checked = siteData.ssl_enabled || false;
    updateSSLSection();
    updateSSLStatus(siteData);
}

function setupFormHandlers() {
    // Type radio buttons
    document.querySelectorAll('input[name="type"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            showConfigSection(e.target.value);
        });
    });
    
    // SSL checkbox
    document.getElementById('sslEnabled').addEventListener('change', updateSSLSection);
    
    // Form submission
    document.getElementById('editSiteForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await updateSite();
    });
}

function showConfigSection(type) {
    // Hide all dynamic type-specific config sections
    document.getElementById('staticConfig').style.display = 'none';
    document.getElementById('proxyConfig').style.display = 'none';
    document.getElementById('loadBalancerConfig').style.display = 'none';
    
    // Show selected config section
    if (type === 'static') {
        document.getElementById('staticConfig').style.display = 'block';
    } else if (type === 'proxy') {
        document.getElementById('proxyConfig').style.display = 'block';
    } else if (type === 'load_balancer') {
        document.getElementById('loadBalancerConfig').style.display = 'block';
    }
}

function addServerInput(value = '') {
    const serversList = document.getElementById('serversList');
    const inputGroup = document.createElement('div');
    inputGroup.className = 'input-group mb-2';
    inputGroup.innerHTML = `
        <input type="url" class="form-control upstream-server" placeholder="http://server:port" value="${value}">
        <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">
            <i class="fas fa-trash"></i>
        </button>
    `;
    serversList.appendChild(inputGroup);
}

async function updateSite() {
    const formData = new FormData(document.getElementById('editSiteForm'));
    const siteType = formData.get('type');
    
    // Build update request
    const updateData = {
        domain: formData.get('domain'),
        type: siteType,
        config: {}
    };
    
    // Add type-specific configuration
    if (siteType === 'static') {
        const indexFiles = document.getElementById('indexFiles').value
            .split(',')
            .map(f => f.trim())
            .filter(f => f);
        updateData.config.index_files = indexFiles;
        
    } else if (siteType === 'proxy') {
        const upstreamUrl = document.getElementById('upstreamUrl').value;
        if (!upstreamUrl) {
            showToast('Error', 'Upstream URL is required for proxy sites', 'error');
            return;
        }
        updateData.config.upstream_url = upstreamUrl;
        
    } else if (siteType === 'load_balancer') {
        const servers = Array.from(document.querySelectorAll('.upstream-server'))
            .map(input => input.value.trim())
            .filter(url => url);
        
        if (servers.length === 0) {
            showToast('Error', 'At least one upstream server is required', 'error');
            return;
        }
        updateData.config.upstream_servers = servers;
    }
    
    try {
        const response = await fetchWithAuth(`/api/sites/${siteId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        });
        
        if (response.ok) {
            showToast('Success', 'Site updated successfully', 'success');
            setTimeout(() => {
                window.location.href = `/sites/${siteId}`;
            }, 1500);
        } else {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to update site');
        }
        
    } catch (error) {
        console.error('Error updating site:', error);
        showToast('Error', error.message, 'error');
    }
}

async function testConfiguration() {
    // Gather current form data
    const formData = new FormData(document.getElementById('editSiteForm'));
    const siteType = formData.get('type');
    
    if (!siteType) {
        showToast('Warning', 'Please select a site type', 'warning');
        return;
    }
    
    // Validate type-specific requirements
    if (siteType === 'proxy') {
        const upstreamUrl = document.getElementById('upstreamUrl').value;
        if (!upstreamUrl) {
            showToast('Error', 'Upstream URL is required for proxy sites', 'error');
            return;
        }
        
        // Test if URL is valid
        try {
            new URL(upstreamUrl);
            showToast('Info', 'Configuration appears valid. Testing nginx syntax...', 'info');
        } catch {
            showToast('Error', 'Invalid upstream URL format', 'error');
            return;
        }
        
    } else if (siteType === 'load_balancer') {
        const servers = Array.from(document.querySelectorAll('.upstream-server'))
            .map(input => input.value.trim())
            .filter(url => url);
        
        if (servers.length === 0) {
            showToast('Error', 'At least one upstream server is required', 'error');
            return;
        }
        
        // Test if all URLs are valid
        for (const server of servers) {
            try {
                new URL(server);
            } catch {
                showToast('Error', `Invalid server URL: ${server}`, 'error');
                return;
            }
        }
        
        showToast('Info', 'Configuration appears valid. Testing nginx syntax...', 'info');
    } else {
        showToast('Info', 'Static site configuration is valid', 'info');
    }
    
    // Could make an API call here to test nginx config syntax
    setTimeout(() => {
        showToast('Success', 'Configuration test passed', 'success');
    }, 1000);
}

function cancelEdit() {
    if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
        window.location.href = `/sites/${siteId}`;
    }
}

// SSL Functions
function updateSSLSection() {
    const sslEnabled = document.getElementById('sslEnabled').checked;
    const sslOptions = document.getElementById('sslOptions');
    
    if (sslEnabled) {
        sslOptions.classList.remove('d-none');
    } else {
        sslOptions.classList.add('d-none');
    }
}

function updateSSLStatus(siteData) {
    const statusDiv = document.getElementById('sslStatus');
    const certInfo = document.getElementById('sslCertInfo');
    const renewBtn = document.getElementById('renewCertBtn');
    const generateBtn = document.getElementById('generateCertBtn');
    
    if (!siteData.ssl_enabled) {
        statusDiv.innerHTML = '<span class="badge bg-secondary">Disabled</span>';
        certInfo.classList.add('d-none');
        renewBtn.style.display = 'none';
        generateBtn.style.display = 'block';
        return;
    }
    
    const status = siteData.ssl_status || 'disabled';
    let badgeClass = 'bg-secondary';
    let statusText = 'Disabled';
    
    switch (status) {
        case 'active':
            badgeClass = 'bg-success';
            statusText = 'Active';
            break;
        case 'pending':
            badgeClass = 'bg-warning';
            statusText = 'Pending';
            break;
        case 'expired':
            badgeClass = 'bg-danger';
            statusText = 'Expired';
            break;
        case 'error':
            badgeClass = 'bg-danger';
            statusText = 'Error';
            break;
    }
    
    statusDiv.innerHTML = `<span class="badge ${badgeClass}">${statusText}</span>`;
    
    // Show certificate info if active
    if (status === 'active' && siteData.ssl_expiry_date) {
        document.getElementById('certStatus').textContent = statusText;
        
        const expiryDate = new Date(siteData.ssl_expiry_date);
        document.getElementById('certExpiry').textContent = expiryDate.toLocaleDateString();
        
        const daysLeft = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
        document.getElementById('certDaysLeft').textContent = daysLeft > 0 ? daysLeft : 'Expired';
        
        certInfo.classList.remove('d-none');
        renewBtn.style.display = 'block';
        generateBtn.style.display = 'none';
    } else {
        certInfo.classList.add('d-none');
        renewBtn.style.display = 'none';
        generateBtn.style.display = 'block';
    }
}

async function generateSSLCertificate() {
    const email = document.getElementById('sslEmail').value;
    if (!email) {
        showToast('Error', 'Email is required for SSL certificate generation', 'error');
        return;
    }
    
    if (!originalSiteData.enabled) {
        showToast('Error', 'Site must be enabled before generating SSL certificate', 'error');
        return;
    }
    
    const generateBtn = document.getElementById('generateCertBtn');
    const originalText = generateBtn.innerHTML;
    
    try {
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generating...';
        
        const response = await fetchWithAuth(`/api/ssl/sites/${siteId}/enable`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email: email })
        });
        
        if (response.ok) {
            const result = await response.json();
            showToast('Success', 'SSL certificate generated successfully', 'success');
            
            // Reload site data to update SSL status
            await loadSiteData();
        } else {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to generate SSL certificate');
        }
    } catch (error) {
        showToast('Error', error.message, 'error');
    } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = originalText;
    }
}

async function renewSSLCertificate() {
    const renewBtn = document.getElementById('renewCertBtn');
    const originalText = renewBtn.innerHTML;
    
    try {
        renewBtn.disabled = true;
        renewBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Renewing...';
        
        const response = await fetchWithAuth(`/api/ssl/sites/${siteId}/renew`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ force: true })
        });
        
        if (response.ok) {
            const result = await response.json();
            showToast('Success', 'SSL certificate renewed successfully', 'success');
            
            // Reload site data to update SSL status
            await loadSiteData();
        } else {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to renew SSL certificate');
        }
    } catch (error) {
        showToast('Error', error.message, 'error');
    } finally {
        renewBtn.disabled = false;
        renewBtn.innerHTML = originalText;
    }
}
</script>
{% endblock %}